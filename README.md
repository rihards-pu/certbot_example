# _Docker Compose stack for a sample whoami web service_

This stack runs a web server behind an Nginx proxy which is using Certbot to acquire certificates from Letsencrypt.
Such combination was chosen as it is an industry standard. The software is popular with plenty of documentation and community support.
Certbot in this case uses Google DNS API to create necessary txt records (DNS-01 challenge) for domain validation - more advanced way compared to HTTP-01 challenge and doesn't rely on a running webserver. 

### Prerequisites
- Prepare your docker host and expose port 443 to the Internet
- Obtain a domain name and delegate the DNS zone to Google Cloud DNS
- Create service account with DNS Administrator role and generate access key for the account (save the key information)

### Deployment Instructions
1. Download source code from https://github.com/rihards-pu/certbot_example to the docker host using your your preferred method (i.e. git clone, zip);
2. Edit the `.env` file and replace the e-mail address and the FQDN of your web service with your information. The variables are used in compose.yml file, to generate Nginx configuraion and to generate the SSL certificates ;
3. Place the Google access key information in to `config/certbot/google.json` file;
4. Start the stack by running commands in the root of the downloaded project:
``` 
docker compose build
docker compose up -d
```
5. Ensure that the stack is running by executing `docker ps` command - there should be 2 containers running: "webserver" and "proxy";
6. Ensure that the certificates have been generated by running `docker logs certbot` command to check the status of certbot container;
7. Open your website using Internet browser. If all went well you will see https://github.com/traefik/whoami website running in your setup which will display basic system information.
8. Schedule Certbot to run once a week at 23:00 on Sundays to check and renew the certificates when they expire by running this command __on your Docker host__:
```
crontab -l | { cat; echo "0 23 * * 7 docker compose start certbot -d"; } | crontab -
```
